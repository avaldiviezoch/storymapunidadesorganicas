<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ejecución Presupuestal por Oficina según Fuente de Financiamiento y Específica</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    /* === MODO FLOTANTE: fondo transparente === */
    --bg:transparent; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --ok:#16a34a; --mid:#f59e0b; --bad:#ef4444;
    --fs-body:13.5px; --fs-head:13.2px;
  }

  /* === Layout flotante (sin tarjeta, sin sombra, sin borde) === */
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui, Segoe UI, Roboto, Arial; overflow:hidden;
  }
  .wrap{height:100vh;display:flex;align-items:stretch;justify-content:center;padding:0}
  .card{
    flex:1; max-width:1400px;
    background:transparent; border:0; border-radius:0; box-shadow:none;
    display:flex; flex-direction:column; overflow:hidden;
  }

  .header{padding:10px 0 8px; border-bottom:0; text-align:center}
  .title{margin:0;font-weight:800;font-size:clamp(16px,2.2vw,22px)}
  .subtitle{margin:4px 0 0 0;color:var(--muted);font-size:12.5px}

  /* Solo “cuadro” = tabla centrada y scroll interno */
  .table-wrap{flex:1 1 auto; overflow:auto}
  table{width:100%; border-collapse:separate; border-spacing:0; font-size:var(--fs-body); margin:0 auto}
  thead th{
    position:sticky; top:0; z-index:30; background:#1e293b; color:#fff; font-weight:800; text-align:center;
    padding:9px; border-bottom:2px solid #0b1220
  }
  thead th:first-child{left:0; z-index:40; position:sticky; background:#1e293b}
  tbody td,tbody th{padding:8px; border-bottom:1px solid var(--line); background:#fff; vertical-align:middle}
  tbody th{background:#f8fafc}
  .num{text-align:right; white-space:nowrap; font-variant-numeric:tabular-nums}
  .pct{text-align:center; white-space:nowrap}

  /* === Chips de rango de alto contraste === */
  .rango{
    display:inline-block; padding:3px 9px; border-radius:999px; font-weight:900; font-size:12px;
    text-transform:uppercase; letter-spacing:.3px; line-height:1.05; border:2px solid transparent;
    box-shadow:0 4px 14px rgba(0,0,0,.06);
  }
  .rango.alto{
    color:#065f46; background:#bbf7d0; border-color:#10b981;
    box-shadow:0 0 0 2px rgba(16,185,129,.18) inset, 0 4px 14px rgba(16,185,129,.16);
  }
  .rango.medio{
    color:#7c2d12; background:#fde68a; border-color:#f59e0b;
    box-shadow:0 0 0 2px rgba(245,158,11,.22) inset, 0 4px 14px rgba(245,158,11,.16);
  }
  .rango.bajo{
    color:#7f1d1d; background:#fecaca; border-color:#ef4444;
    box-shadow:0 0 0 2px rgba(239,68,68,.22) inset, 0 4px 14px rgba(239,68,68,.16);
  }

  /* Niveles jerárquicos */
  .h1{font-weight:800;font-size:14px}
  .h2{font-weight:400;font-size:14px}
  .h3{font-style:italic;font-size:13px}

  /* Botones expansores */
  .btn{
    border:0; background:transparent; cursor:pointer; font:inherit; color:inherit;
    display:grid; grid-template-columns:1.3rem 1fr; align-items:center; column-gap:.4rem; text-align:left;
  }

  /* Flechas animadas */
  .chev{
    --chev-color:#ea580c; --chev-glow:rgba(234,88,12,.45);
    width:1.3rem; height:1.3rem; position:relative; display:inline-grid; place-items:center; color:var(--chev-color);
  }
  .chev .arrow{position:absolute; width:16px; height:16px; opacity:0; filter:drop-shadow(0 5px 10px var(--chev-glow)); animation:chevDrip 1.8s ease-in-out infinite}
  .chev .arrow:nth-child(2){animation-delay:.22s}
  .chev .arrow:nth-child(3){animation-delay:.44s}
  @keyframes chevDrip{0%{transform:translateY(-8px) scale(.95);opacity:0}20%{transform:translateY(-2px) scale(1);opacity:1}60%{transform:translateY(6px) scale(1.04);opacity:.95}100%{transform:translateY(12px) scale(1);opacity:0}}
  .chev.segundo-nivel{--chev-color:#0ea5e9; --chev-glow:rgba(14,165,233,.45)}

  tfoot td{background:#f8fafc; font-weight:900; padding:10px; border-top:2px solid #94a3b8}

  /* Franja de fuente/fecha SIN borde para mantener flotante */
  .source{padding:8px 10px; text-align:center; color:#334155; font-size:12.5px; border-top:0}
  .source b{color:#0369a1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h2 class="title">Ejecución Presupuestal por Oficina según Fuente de Financiamiento y Específica</h2>
      <p class="subtitle">Rango: <strong>Bajo / Medio / Alto</strong></p>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Oficina / Fuente / Específica</th>
            <th>PIA</th><th>PIM</th><th>Certif.</th><th>Comp.Anual</th><th>Devengado</th><th>Girado</th>
            <th>% Avance</th><th>Rango</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>

    <p class="source">
      <b>Fuente:</b> Ministerio de Economía y Finanzas — MEF · Portal de Datos Abiertos ·
      <em id="lastUpdate">Actualizado al —</em>
    </p>
  </div>
</div>

<script>
const SERVICE="https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer/13/query";
const WHERE="pliego = '037' AND ejecutora = '001' AND ano_eje = 2025";

const F={
  oficina:"oficina",
  fuente:"fuente_financiamiento_nombre",
  espec:"especifica_det_nombre",
  pia:"monto_pia", pim:"monto_pim", cert:"monto_certificado",
  comp:"monto_comprometido_anual", dev:"monto_devengado", gir:"monto_girado",
  fecha:"fecha_proceso"
};

const fmt=new Intl.NumberFormat('es-PE');
const pct=(a,b)=>(!b||b<=0)?0:(a/b*100);
const rango=p=>p<30?'bajo':(p<70?'medio':'alto');
const rangoTxt=p=>p<30?'Bajo':(p<70?'Medio':'Alto');

async function rest(params){
  const qs=new URLSearchParams(params);
  const url=SERVICE+"?"+qs.toString();
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const j=await res.json();
  if(j.error) throw new Error(j.error.message || "Error del servicio");
  return j;
}

async function query(){
  const outStats=JSON.stringify([
    {statisticType:'sum',onStatisticField:F.pia,outStatisticFieldName:'pia'},
    {statisticType:'sum',onStatisticField:F.pim,outStatisticFieldName:'pim'},
    {statisticType:'sum',onStatisticField:F.cert,outStatisticFieldName:'cert'},
    {statisticType:'sum',onStatisticField:F.comp,outStatisticFieldName:'comp'},
    {statisticType:'sum',onStatisticField:F.dev,outStatisticFieldName:'dev'},
    {statisticType:'sum',onStatisticField:F.gir,outStatisticFieldName:'gir'}
  ]);
  const j=await rest({
    where:WHERE,
    groupByFieldsForStatistics:`${F.oficina},${F.fuente},${F.espec}`,
    outFields:`${F.oficina},${F.fuente},${F.espec}`,
    outStatistics:outStats, returnGeometry:'false', f:'json'
  });
  return (j.features||[]).map(f=>f.attributes);
}

async function getMaxFecha(){
  const outStats=JSON.stringify([{statisticType:'max', onStatisticField:F.fecha, outStatisticFieldName:'max_fp'}]);
  const j=await rest({ where:WHERE, outStatistics:outStats, returnGeometry:'false', f:'json' });
  const a=j.features?.[0]?.attributes||{};
  const ts=(a.max_fp!=null)?Number(a.max_fp):null;
  return Number.isFinite(ts)?ts:null;
}

function build(rows){
  const tree=new Map();
  let total={pia:0,pim:0,cert:0,comp:0,dev:0,gir:0};
  for(const r of rows){
    total.pia+=r.pia; total.pim+=r.pim; total.cert+=r.cert; total.comp+=r.comp; total.dev+=r.dev; total.gir+=r.gir;
    if(!tree.has(r[F.oficina])) tree.set(r[F.oficina],new Map());
    const sub=tree.get(r[F.oficina]);
    if(!sub.has(r[F.fuente])) sub.set(r[F.fuente],[]);
    sub.get(r[F.fuente]).push(r);
  }
  return {tree,total};
}

function cells(v){
  const p=pct(v.dev,v.pim); const r=rango(p);
  return `
    <td class="num">${fmt.format(v.pia)}</td>
    <td class="num">${fmt.format(v.pim)}</td>
    <td class="num">${fmt.format(v.cert)}</td>
    <td class="num">${fmt.format(v.comp)}</td>
    <td class="num">${fmt.format(v.dev)}</td>
    <td class="num">${fmt.format(v.gir)}</td>
    <td class="pct">${isFinite(p)?p.toFixed(1)+'%':'—'}</td>
    <td class="pct"><span class="rango ${r}">${rangoTxt(p)}</span></td>`;
}

/* Flecha animada (primer nivel, naranja) */
function chevHTML(){
  return `
    <span class="chev" aria-hidden="true">
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
    </span>`;
}

/* Flecha animada (segundo nivel, celeste) */
function chevHTML2(){
  return `
    <span class="chev segundo-nivel" aria-hidden="true">
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
      <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 4v12"></path><path d="M8 12l4 4 4-4"></path>
      </svg>
    </span>`;
}

function addToggle(){
  document.querySelectorAll('button[aria-controls]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.getAttribute('aria-controls');
      const exp=btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded',String(!exp));
      document.querySelectorAll(`[data-parent="${id}"]`).forEach(tr=>{
        tr.style.display=exp?'none':'';
      });
    });
  });
}

function render({tree,total}){
  const TB=document.getElementById('tbody'), TF=document.getElementById('tfoot');
  TB.innerHTML='';
  for(const [ofi,fuentes] of tree.entries()){
    let aggO={pia:0,pim:0,cert:0,comp:0,dev:0,gir:0};
    for(const arr of fuentes.values()) for(const x of arr)
      for(const k of ['pia','pim','cert','comp','dev','gir']) aggO[k]+=x[k];

    const oId='o_'+btoa(ofi);
    TB.insertAdjacentHTML('beforeend',`
      <tr>
        <th class="h1">
          <button class="btn" aria-expanded="false" aria-controls="${oId}">
            ${chevHTML()} <span class="label">${ofi}</span>
          </button>
        </th>
        ${cells(aggO)}
      </tr>`);

    for(const [fuente, arr] of fuentes.entries()){
      let aggF={pia:0,pim:0,cert:0,comp:0,dev:0,gir:0};
      arr.forEach(x=>{for(const k in aggF) aggF[k]+=x[k];});
      const fId='f_'+btoa(ofi+fuente);
      TB.insertAdjacentHTML('beforeend',`
        <tr data-parent="${oId}" style="display:none">
          <th class="h2" style="padding-left:25px">
            <button class="btn" aria-expanded="false" aria-controls="${fId}">
              ${chevHTML2()} ${fuente}
            </button>
          </th>
          ${cells(aggF)}
        </tr>`);

      arr.forEach(x=>{
        TB.insertAdjacentHTML('beforeend',`
          <tr data-parent="${fId}" style="display:none">
            <td class="h3" style="padding-left:50px">${x[F.espec]}</td>${cells(x)}
          </tr>`);
      });
    }
  }
  TF.innerHTML=`<tr><th class="h1">TOTAL</th>${cells(total)}</tr>`;
  addToggle();
}

function formatEsDate(ts){
  if(!Number.isFinite(ts)) return "—";
  return new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"long",year:"numeric"}).format(new Date(ts));
}

(async()=>{
  try{
    const [rows, maxTs]=await Promise.all([ query(), getMaxFecha() ]);
    render(build(rows));
    document.getElementById('lastUpdate').textContent = "Actualizado al " + (maxTs ? formatEsDate(maxTs) : "—");
  }catch(err){
    console.error(err);
    document.getElementById('lastUpdate').textContent = "Actualizado al —";
  }
})();
</script>
</body>
</html>
