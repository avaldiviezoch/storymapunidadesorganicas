<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PIM vs Devengado por Oficina — 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    #wrap{position:relative;height:100vh;width:100vw}
    #chart{height:100%;width:100%}

    /* Leyenda en línea, bajo el título (interactiva) */
    .legend-inline{
      position:absolute;
      left:50%; transform:translateX(-50%);
      top:46px; z-index:10;
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      background:rgba(255,255,255,.9);
      border:1px solid #e5e7eb; border-radius:10px;
      padding:6px 12px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
      font-size:12px; color:#374151;
      pointer-events:auto;
      user-select:none;
    }
    .lg-title{font-weight:700;margin-right:4px}
    .lg-chip{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.08);flex:0 0 auto}
    .legend-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:3px 6px;border-radius:8px;transition:background .15s ease}
    .legend-item:hover{background:#f8fafc}
    .legend-item.off{opacity:.45;filter:grayscale(.25)}
    .muted{color:#6b7280}

    @media (max-width: 720px){
      .legend-inline{top:56px}
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="chart"></div>

  <!-- Leyenda en línea (clic para filtrar por color de Avance) -->
  <div class="legend-inline" id="legend">
    <span class="lg-title">Leyenda:</span>
    <div class="legend-item" data-key="bajo" title="Filtrar avance &lt; 30%">
      <span class="lg-chip" style="background:#e74c3c"></span><span>Bajo (&lt; 30%)</span>
    </div>
    <div class="legend-item" data-key="medio" title="Filtrar avance 30%–&lt;70%">
      <span class="lg-chip" style="background:#f39c12"></span><span>Medio (30%–&lt;70%)</span>
    </div>
    <div class="legend-item" data-key="alto" title="Filtrar avance ≥ 70%">
      <span class="lg-chip" style="background:#2ecc71"></span><span>Alto (≥ 70%)</span>
    </div>
    <div class="legend-item" data-key="sindato" title="Filtrar sin dato">
      <span class="lg-chip" style="background:#9e9e9e"></span><span class="muted">Sin dato</span>
    </div>
    <div class="legend-item" style="cursor:default" title="Tamaño de burbuja">
      <span class="muted">· Tamaño: PIM (millones S/)</span>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG VISUAL ===================== */
const DOT_BORDER = {
  color: '#0f172a',   // Color del borde
  width: 0.6,         // Espesor del borde en px
  type: 'solid',      // 'solid' | 'dashed' | 'dotted'
  opacity: 0.90       // Opacidad del relleno
};
/* ========================================================= */

/* ====== Servicio y filtros (mismos que en las tablas) ====== */
const SERVICE = "https://pportalgis.vivienda.gob.pe/pfdserver/rest/services/OGEI/Mapa_Inversiones_MEF/MapServer/13/query";
const WHERE   = "pliego = '037' AND ejecutora = '001' AND ano_eje = 2025";

/* ====== Campos ====== */
const F = {
  oficina: "oficina",
  pim: "monto_pim",
  dev: "monto_devengado"
};

/* ============ Utilidades ============ */
function qs(url, params){ return url + "?" + new URLSearchParams(params).toString(); }
function extent(arr){let m=+Infinity,M=-Infinity;for(const v of arr)if(Number.isFinite(v)){if(v<m)m=v;if(v>M)M=v}if(!Number.isFinite(m)||!Number.isFinite(M))return[0,1];if(m===M)return[0,M||1];return[m,M]}
function quantile(a,q){const s=a.slice().sort((x,y)=>x-y);if(!s.length)return NaN;const p=(s.length-1)*q,lo=Math.floor(p),hi=Math.ceil(p);return lo===hi?s[lo]:s[hi]+(s[hi]-s[lo])*(p-lo)}
const pf1 = new Intl.NumberFormat('es-PE',{ maximumFractionDigits:1 });
const pf2 = new Intl.NumberFormat('es-PE',{ maximumFractionDigits:2 });

/* a millones */
const toM = v => (v||0)/1e6;

/* categoría y color por avance */
function avanceCategory(p){
  if(!Number.isFinite(p)) return 'sindato';
  if(p < 30) return 'bajo';
  if(p < 70) return 'medio';
  return 'alto';
}
const COLOR = { bajo:'#e74c3c', medio:'#f39c12', alto:'#2ecc71', sindato:'#9e9e9e' };

/* tamaño burbuja por PIM (millones) con límites */
function makeSizeFn(values, minPx=10, maxPx=58){
  const [mn,mx]=extent(values);
  return x=>{
    const v=Math.max(0,Number(x)||0);
    let t=(mx>mn)?(v-mn)/(mx-mn):0.5;
    t=Math.max(0,Math.min(1,t));
    return minPx + Math.sqrt(t)*(maxPx-minPx);
  };
}

/* ============ Carga de datos (agrupado por Oficina) ============ */
async function fetchAggOficinas(){
  const outStats = JSON.stringify([
    { statisticType:"sum", onStatisticField:F.pim, outStatisticFieldName:"sum_pim" },
    { statisticType:"sum", onStatisticField:F.dev, outStatisticFieldName:"sum_dev" }
  ]);
  const url = qs(SERVICE, {
    where: WHERE,
    groupByFieldsForStatistics: F.oficina,
    outFields: F.oficina,
    outStatistics: outStats,
    orderByFields: "sum_pim DESC",
    returnGeometry: "false",
    f: "json"
  });
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const j = await res.json();
  if(j.error) throw new Error(j.error.message || "Error del servicio");
  return (j.features||[]).map(f=>{
    const a=f.attributes||{};
    const name=a[F.oficina] ?? "(Sin oficina)";
    const pim=a.sum_pim||0, dev=a.sum_dev||0;
    const x=toM(pim), y=toM(dev), avance = (!pim||pim<=0) ? NaN : (dev/pim*100);
    const cat = avanceCategory(avance);
    return { name, pim, dev, xM:x, yM:y, avance, cat };
  }).filter(r => Number.isFinite(r.xM) && Number.isFinite(r.yM));
}

/* ====== Estado de filtros por leyenda ====== */
const legendState = { bajo:true, medio:true, alto:true, sindato:true };

/* ================== Render ================== */
(async function run(){
  const chart = echarts.init(document.getElementById('chart'));
  try{
    chart.showLoading({ text: 'Cargando datos…' });

    const rows = await fetchAggOficinas();
    if(!rows.length) throw new Error('No se encontraron datos por oficina.');

    const allX = rows.map(r=>r.xM);
    const allY = rows.map(r=>r.yM);
    const sizeFn = makeSizeFn(allX, 10, 70); // tamaño ~ PIM (millones)

    // Rango de ejes con percentiles y padding
    const xQ05=quantile(allX,0.05), xQ95=quantile(allX,0.95);
    const yQ05=quantile(allY,0.05), yQ95=quantile(allY,0.95);
    const xPad=(xQ95-xQ05)*0.08, yPad=(yQ95-yQ05)*0.08;
    const [xMinAll,xMaxAll]=extent(allX), [yMinAll,yMaxAll]=extent(allY);
    const xInitMin = Math.max(0, Math.min(xQ05-xPad, xMinAll));
    const xInitMax = Math.max(xQ95+xPad, xMaxAll);
    const yInitMin = Math.max(0, Math.min(yQ05-yPad, yMinAll));
    const yInitMax = Math.max(yQ95+yPad, yMaxAll);

    function toPoint(r){
      return {
        value:[r.xM, r.yM, r.name, r.avance],
        itemStyle:{
          color: COLOR[r.cat],
          opacity: DOT_BORDER.opacity,
          borderColor: DOT_BORDER.color,
          borderWidth: DOT_BORDER.width,
          borderType: DOT_BORDER.type
        },
        emphasis:{
          itemStyle:{ borderColor: DOT_BORDER.color, borderWidth: Math.max(DOT_BORDER.width+0.5, DOT_BORDER.width) },
          scale:1.08, focus:'self'
        }
      };
    }

    function buildSeries(){
      const cats = ['bajo','medio','alto','sindato'];
      return cats.map(cat=>({
        name: cat,
        type:'scatter',
        data: legendState[cat] ? rows.filter(r=>r.cat===cat).map(toPoint) : [],
        symbolSize:(val)=> sizeFn(val[0]), // tamaño por PIM (X, millones)
        label:{ show:false }
      }));
    }

    const option={
      title:[
        { text: '2025', right: 140, bottom: 48, textAlign: 'right',
          textStyle: { fontSize: 32, fontWeight: 700, color: '#e5e7eb' } },
        { text: 'PIM vs Devengado por Oficina',
          left: 'center', top: 8, textStyle: { fontWeight: '700', fontSize: 16 } }
      ],
      tooltip:{
        padding:6, borderWidth:1,
        formatter:(obj)=>{
          const [xM,yM,name,avc] = obj.value;
          const aTxt = Number.isFinite(avc)? pf1.format(avc)+' %' : '—';
          return `
            <b>Oficina:</b> ${name}<br>
            <b>PIM (X):</b> S/ ${pf2.format(xM)} mill.<br>
            <b>Devengado (Y):</b> S/ ${pf2.format(yM)} mill.<br>
            <b>Avance (Color):</b> ${aTxt}
          `;
        }
      },
      grid:{ top:86, left:52, right:26, bottom:60, containLabel:true },
      xAxis:{
        type:'value', name:'PIM (millones S/)',
        min:xInitMin, max:xInitMax, nameGap:25, nameLocation:'middle',
        nameTextStyle:{ fontSize:14 }, splitLine:{ show:true }, scale:true,
        axisLabel:{ formatter:(v)=>pf1.format(v) }
      },
      yAxis:{
        type:'value', name:'Devengado (millones S/)',
        min:yInitMin, max:yInitMax, nameTextStyle:{ fontSize:14 }, splitLine:{ show:true }, scale:true,
        axisLabel:{ formatter:(v)=>pf1.format(v) }
      },
      dataZoom:[
        { type:'slider', xAxisIndex:0, filterMode:'none', bottom:12, height:28 },
        { type:'inside', xAxisIndex:0, filterMode:'none' },
        { type:'slider', yAxisIndex:0, filterMode:'none', right:6, width:12 },
        { type:'inside', yAxisIndex:0, filterMode:'none' }
      ],
      series: buildSeries(),
      animationDurationUpdate:800,
      animationEasingUpdate:'quinticInOut'
    };

    chart.hideLoading();
    chart.setOption(option);

    // Interacción de la leyenda HTML (toggle por categoría)
    document.querySelectorAll('#legend .legend-item[data-key]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const key = el.getAttribute('data-key');
        legendState[key] = !legendState[key];
        el.classList.toggle('off', !legendState[key]);
        chart.setOption({ series: buildSeries() }, { replaceMerge:['series'] });
      });
    });

    window.addEventListener('resize', ()=>chart.resize());
  }catch(err){
    console.error(err);
    chart.setOption({
      title:{ text:'Error al cargar datos', left:'center' },
      graphic:{ type:'text', left:'center', top:'middle',
        style:{ text: (err&&err.message)? err.message : 'Fallo de carga.', fontSize:14 } }
    });
  }
})();
</script>
</body>
</html>
